<!DOCTYPE html>
<html>
<head>
	
    <meta charset="UTF-8">
    <script src="vendors/jQuery/jquery-3.2.1.min.js"></script>
  	<link rel="stylesheet" href="test.css">
	<title>Draw SVG</title>
	
</head>

    <body>
        <div id="image"></div>
    </body>

    <script>
        var t0 = performance.now();
        var post_data = new FormData();
        post_data.append('transaction', 'getPolygon');
        post_data.append('master_image_id', 3737);
        jQuery.ajax({
    	url: 'resources/cgi-bin/GetImageData.pl',
    	data: post_data,
    	cache: false,
    	contentType: false,
    	processData: false,
    	type: 'POST',
    	success: function(results){
			results['results'].forEach(function(entry) {
				var data = entry['ST_AsText(region_in_master_image)'];
                var polygons = data.split("\),\(");
                var new_polygons = '';
                polygons.forEach(function(polygon, index) {
                    new_polygons += 'M';
                    polygon = polygon.replace(/POLYGON/g, "");
                    polygon = polygon.replace(/\(/g, "");
                    polygon = polygon.replace(/\)/g, "");
                    var points = polygon.split(",");
                    points.forEach(function(point) {
                        if (new_polygons.slice(-1) !== 'M'){
                            new_polygons += 'L';
                        }
                        new_polygons += (point.split(' ')[0] - 1375) + ' ' + (point.split(' ')[1] - 365);
                    }, this);
                }, this);

                var image = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                image.setAttribute('id', 'SVG-' + "test");
                image.setAttribute('class', 'fragment');
                image.setAttribute('pointer-events', 'none');
                image.setAttribute('draggable', 'false');
                
                var pathDefs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute('id', 'Path-' + "test");
                
                var clipPathDefs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                clipPath = document.createElementNS("http://www.w3.org/2000/svg", "clipPath");
                clipPath.setAttribute('id', 'Clip-' + "test");
                var clipPathPath = document.createElementNS("http://www.w3.org/2000/svg", "use");
                clipPathPath.setAttribute('stroke', 'none');
                clipPathPath.setAttribute('fill', 'black');
                clipPathPath.setAttribute('fill-rule', 'evenodd');
                clipPathPath.setAttributeNS("http://www.w3.org/1999/xlink", 'xlink:href', '#Path-' + "test");
                
                var imgContainer = document.createElementNS("http://www.w3.org/2000/svg", "g");
                imgContainer.setAttribute('id', 'Container-' + "test");
                imgContainer.setAttribute('clip-path', 'url(#' + 'Clip-' + "test" + ')');
                imgContainer.setAttribute('pointer-events', 'visiblePainted');
                var svgImage = document.createElementNS("http://www.w3.org/2000/svg", "image");
                svgImage.setAttribute('id', 'ClippedImg-' + "test");
                svgImage.setAttribute('class', 'clippedImg');
                svgImage.setAttribute('draggable', 'false');
                
                var outline = document.createElementNS("http://www.w3.org/2000/svg", "use");
                outline.setAttribute('stroke', 'blue');
                outline.setAttribute('stroke-width', '3');
                outline.setAttribute('fill', 'none');
                outline.setAttribute('fill-rule', 'evenodd');
                outline.setAttribute('id', 'fragOutline-' + "test");
                outline.setAttribute('class', 'fragOutline');
                outline.setAttributeNS("http://www.w3.org/1999/xlink", 'xlink:href', '#Path-' + "test");
                
                pathDefs.appendChild(path);
                clipPath.appendChild(clipPathPath);
                clipPathDefs.appendChild(clipPath);
                imgContainer.appendChild(svgImage);
                image.appendChild(pathDefs);
                image.appendChild(clipPathDefs);
                image.appendChild(imgContainer);
                image.appendChild(outline);

                var scale = 0.1;
                var width = 5060;
                var height = 8415;
                path.setAttribute('d', new_polygons);
                path.setAttribute('transform', 'scale(' + scale + ')');
                svgImage.setAttributeNS("http://www.w3.org/1999/xlink", 'xlink:href', "http://134.76.19.179/cgi-bin/iipsrv.fcgi?IIIF=P998-Fg001-R-C01-R01-D14112013-T094905-LR445__ColorCalData_IAA_Left_CC110304_110702-ST.tif/1375,365,5060,8415/pct:" + (scale * 100) + "/0/default.jpg");
                svgImage.setAttribute('width', width * scale);
                svgImage.setAttribute('height', height * scale);
                image.setAttribute('width', width * scale);
                image.setAttribute('height', height * scale);

                var cont = document.getElementById('image');
                cont.appendChild(image);
                var t1 = performance.now();
                console.log("Call to doSomething took " + (t1 - t0) + " milliseconds.");
			});
    	}
	});
        
        
        
        
    </script>
</html>